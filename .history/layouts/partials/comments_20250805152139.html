{{- if .Site.Params.comments.enabled -}}
  {{- if eq .Site.Params.comments.provider "giscus" -}}
    {{- if .Site.Params.comments.giscus.repo -}}
      <div class="pt-3">
        <div class="giscus-comments">
          <script src="https://giscus.app/client.js"
                  data-repo="{{ .Site.Params.comments.giscus.repo }}"
                  data-repo-id="{{ .Site.Params.comments.giscus.repoId }}"
                  data-category="{{ .Site.Params.comments.giscus.category }}"
                  data-category-id="{{ .Site.Params.comments.giscus.categoryId }}"
                  data-mapping="{{ .Site.Params.comments.giscus.mapping | default "pathname" }}"
                  data-strict="{{ .Site.Params.comments.giscus.strict | default "0" }}"
                  data-reactions-enabled="{{ .Site.Params.comments.giscus.reactionsEnabled | default "1" }}"
                  data-emit-metadata="{{ .Site.Params.comments.giscus.emitMetadata | default "0" }}"
                  data-input-position="{{ .Site.Params.comments.giscus.inputPosition | default "bottom" }}"
                  data-theme="{{ .Site.Params.comments.theme | default "github-light" }}"
                  data-lang="{{ .Site.Params.comments.giscus.lang | default "zh-CN" }}"
                  crossorigin="anonymous"
                  async>
          </script>
        </div>

        <!-- 主题切换支持 -->
        <script>
          // 监听主题变化
          function updateGiscusTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            const theme = isDark ? '{{ .Site.Params.comments.darkTheme | default "github-dark" }}' : '{{ .Site.Params.comments.theme | default "github-light" }}';

            const giscusFrame = document.querySelector('iframe.giscus-frame');
            if (giscusFrame) {
              giscusFrame.contentWindow.postMessage({
                giscus: {
                  setConfig: {
                    theme: theme
                  }
                }
              }, 'https://giscus.app');
            }
          }

          // 监听主题切换
          const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
              if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                updateGiscusTheme();
              }
            });
          });

          observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['class']
          });
        </script>
      </div>
    {{- end -}}
  {{- else if eq .Site.Params.comments.provider "disqus" -}}
    {{- template "_internal/disqus.html" . -}}
  {{- else if eq .Site.Params.comments.provider "utterances" -}}
    {{- if .Site.Params.comments.utterances.repo -}}
      <div class="pt-3">
        <script src="https://utteranc.es/client.js"
                repo="{{ .Site.Params.comments.utterances.repo }}"
                issue-term="{{ .Site.Params.comments.utterances.issueTerm | default "pathname" }}"
                theme="{{ .Site.Params.comments.theme | default "github-light" }}"
                crossorigin="anonymous"
                async>
        </script>
      </div>
    {{- end -}}
  {{- end -}}
{{- end -}}